<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button [defaultHref]="['/auth', 'servers', serverId]"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ app.title | async }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding-bottom" *ngVar="{ status: app.status | async, versionInstalled: app.versionInstalled | async } as vars">

  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content pullingIcon="lines" refreshingSpinner="lines"></ion-refresher-content>
  </ion-refresher>

  <ion-item *ngIf="error" style="margin-bottom: 16px;">
    <ion-text class="ion-text-wrap" color="danger">{{ error }}</ion-text>
  </ion-item>

  <ion-spinner *ngIf="loading" class="center" name="lines" color="warning"></ion-spinner>

  <ng-container *ngIf="!loading">

    <ion-item-group>
      <ion-item>
        <ion-label>
          <s9-status [appStatus]="vars.status"></s9-status>
        </ion-label>
        <ng-container *ngIf="vars.status !== 'INSTALLING'">
          <ion-button slot="end" *ngIf="['NEEDS_CONFIG', 'RECOVERABLE'].includes(vars.status)" [routerLink]="['config']" fill="outline" color="warning">
            Config
          </ion-button>
          <ion-button slot="end" *ngIf="vars.status === 'STOPPED'" (click)="start()" fill="outline" color="success">
            Start
          </ion-button>
          <ion-button slot="end" *ngIf="['RUNNING', 'RESTARTING'].includes(vars.status)" (click)="stop()" fill="outline" color="danger">
            Stop
          </ion-button>
        </ng-container>
      </ion-item>
    </ion-item-group>

    <ng-container *ngIf="vars.status !== 'INSTALLING'">

      <ion-button *ngIf="showUpdate && [AppStatus.RUNNING, AppStatus.STOPPED].includes(vars.status)" style="margin: 30px 16px 0 16px;" expand="block" fill="outline" color="warning" (click)="checkForUpdates()">
        Check for Updates
        <ion-icon slot="end" name="refresh-outline"></ion-icon>
      </ion-button>

      <ion-button *ngIf="vars.status === 'DEAD'" style="margin: 30px 16px 0 16px;" expand="block" fill="outline" color="warning" (click)="presentAlertUninstall()">
        Force Uninstall
      </ion-button>

      <ion-item-group class="ion-text-wrap" *ngIf="vars.versionInstalled">
        <ion-item-divider></ion-item-divider>

        <ng-container *ngIf="([AppStatus.NEEDS_CONFIG, AppStatus.RECOVERABLE, AppStatus.RUNNING, AppStatus.STOPPED]).includes(vars.status)">
          <!-- config -->
          <ion-item [routerLink]="['config']">
            <ion-icon slot="start" name="construct-outline" color="primary"></ion-icon>
            <ion-label><ion-text color="primary">Config</ion-text></ion-label>
          </ion-item>
        </ng-container>

        <ng-container *ngIf="vars.status === AppStatus.RUNNING">
          <!-- logs -->
          <ion-item [routerLink]="['logs']">
            <ion-icon slot="start" name="newspaper-outline" color="primary"></ion-icon>
            <ion-label><ion-text color="primary">Logs</ion-text></ion-label>
          </ion-item>
          <!-- metrics -->
          <ion-item [routerLink]="['metrics']">
            <ion-icon slot="start" name="pulse" color="primary"></ion-icon>
            <ion-label><ion-text color="primary">Metrics</ion-text></ion-label>
          </ion-item>
        </ng-container>

        <!-- view store listing -->
        <ion-item [routerLink]="['/auth', 'servers', serverId, 'apps', 'available', appId]">
          <ion-icon slot="start" name="aperture-outline" color="primary"></ion-icon>
          <ion-label><ion-text color="primary">View store listing</ion-text></ion-label>
        </ion-item>

        <ion-item-divider></ion-item-divider>

        <ion-item>
          <ion-label position="stacked">App ID</ion-label>
          <ion-text color="medium">
            <h5>{{ app.id | async }}</h5>
          </ion-text>
        </ion-item>
        <ion-item>
          <ion-label position="stacked">Version</ion-label>
          <ion-text color="medium">
            <h5>{{ vars.versionInstalled }}</h5>
          </ion-text>
        </ion-item>
        <ion-item *ngIf="app.torAddress | async as torAddress">
          <ion-label position="stacked">Tor Address</ion-label>
          <ion-text style="word-break: break-all;" color="medium">
            <h5>{{ torAddress }}</h5>
          </ion-text>
          <ion-note slot="end">
            <ion-button (click)="copyTor()" fill="outline" size="small">
              Copy
            </ion-button>
          </ion-note>
        </ion-item>

        <ion-item-divider></ion-item-divider>

        <ng-container *ngIf="vars.status !== AppStatus.INSTALLING">
          <!-- uninstall -->
          <ion-item button (click)="presentAlertUninstall()">
            <ion-icon slot="start" name="trash-outline" color="danger"></ion-icon>
            <ion-label><ion-text color="danger">Uninstall</ion-text></ion-label>
          </ion-item>
        </ng-container>
      </ion-item-group>

    </ng-container>

  </ng-container>

</ion-content>